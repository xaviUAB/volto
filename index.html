<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Volto Digital</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #020617; /* slate-950 */
            color: #f1f5f9; /* slate-100 */
            user-select: none;
            overflow: hidden;
        }

        /* Animacions */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }

        /* Patró de fons del Palau */
        .palace-pattern {
            background-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 20 20' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 0l10 10-10 10L0 10z' fill='%23000000' fill-opacity='0.1' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Utilitats addicionals */
        .no-drag {
            -webkit-user-drag: none;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-2">

    <!-- Contenidor de l'Aplicació -->
    <div id="app" class="w-full flex flex-col items-center"></div>

    <script>
        // --- CONSTANTS I CONFIGURACIÓ ---
        const ROWS = 7;
        const COLS = 5;
        const WINS_TO_MATCH = 5;

        const SOUNDS = {
            MOVE: 'https://cdn.freesound.org/previews/675/675905_13994793-lq.mp3',
            CAPTURE: 'https://cdn.freesound.org/previews/566/566436_10247858-lq.mp3',
            WIN: 'https://cdn.freesound.org/previews/270/270404_5123851-lq.mp3',
            LOSE: 'https://cdn.freesound.org/previews/76/76376_877451-lq.mp3',
            START: 'https://cdn.freesound.org/previews/320/320673_5260872-lq.mp3'
        };

        const PIECE_COLORS = {
            CANDIDATE: 'text-orange-500', 
            LADY: 'text-red-500',
            SOLDIER: 'text-blue-500',
            COUNSELOR: 'text-purple-500',
            NOBLE: 'text-emerald-500',
        };

        const TYPES = {
            CANDIDATE: { id: 'CANDIDATE', name: 'Candidat', icon: 'crown', value: 1000 },
            LADY: { id: 'LADY', name: 'Dama', icon: 'heart', value: 500 },
            SOLDIER: { id: 'SOLDIER', name: 'Soldat', icon: 'arrow-up', value: 40 },
            COUNSELOR: { id: 'COUNSELOR', name: 'Conseller', icon: 'hexagon', value: 30 },
            NOBLE: { id: 'NOBLE', name: 'Noble', icon: 'shield', value: 30 }
        };

        const BASE_ARMY = [
            TYPES.CANDIDATE,
            TYPES.LADY, TYPES.LADY,
            TYPES.SOLDIER,
            TYPES.COUNSELOR, TYPES.COUNSELOR, TYPES.COUNSELOR,
            TYPES.NOBLE, TYPES.NOBLE, TYPES.NOBLE
        ];

        // --- ESTAT GLOBAL ---
        const state = {
            board: [], // S'inicialitza com a array buit
            phase: 'name', 
            turn: 0,
            selectedPos: null,
            validMoves: [],
            winner: null,
            winReason: "",
            showRules: false,
            soundEnabled: true,
            history: [],
            playerName: "Jugador",
            scores: { player: 0, cpu: 0 },
            lastMove: null,
            cpuStrategy: null,
            animatingMove: null,
            eliminated: { 0: [], 1: [] },
            cpuLastMoveInfo: null,
            observedMoves: {},
            inputText: ""
        };

        // --- LÒGICA DEL JOC (Helpers) ---

        const cloneBoard = (board) => board.map(row => row.map(cell => (cell ? { ...cell } : null)));

        const playSound = (type) => {
            if (!state.soundEnabled) return;
            const audio = new Audio(SOUNDS[type]);
            audio.volume = 0.5;
            audio.play().catch(e => console.log("Audio play failed", e));
        };

        const getValidMoves = (board, r, c, piece) => {
            const moves = [];
            if (!piece) return moves;

            const isPlayer1 = piece.player === 0; 
            const forwardDir = isPlayer1 ? -1 : 1; 
            const goalRow = isPlayer1 ? 0 : ROWS - 1;

            if (piece.type.id === 'SOLDIER' && r === goalRow) return [];

            if (piece.type.id === 'SOLDIER') {
                let currentR = r;
                while (true) {
                    const nextR = currentR + forwardDir;
                    if (nextR < 0 || nextR >= ROWS) break; 

                    const target = board[nextR][c];
                    if (target === null) {
                        currentR = nextR;
                        if (currentR === goalRow) {
                            moves.push({ r: currentR, c: c });
                            break;
                        }
                    } else {
                        if (target.player !== piece.player) {
                            moves.push({ r: nextR, c: c, isCapture: true });
                        } else {
                            if (currentR !== r) moves.push({ r: currentR, c: c });
                        }
                        break;
                    }
                }
                return moves;
            }

            const directions = [];
            if (piece.type.id === 'CANDIDATE' || piece.type.id === 'LADY') {
                [[-1,-1], [-1,0], [-1,1], [0,-1], [0,1], [1,-1], [1,0], [1,1]].forEach(([dr, dc]) => directions.push({dr, dc, max: 1}));
            } else if (piece.type.id === 'NOBLE') {
                [[-1,0], [1,0], [0,-1], [0,1]].forEach(([dr, dc]) => directions.push({dr, dc, max: 1}));
            } else if (piece.type.id === 'COUNSELOR') {
                [[-1,-1], [-1,1], [1,-1], [1,1]].forEach(([dr, dc]) => directions.push({dr, dc, max: 1}));
            } 

            directions.forEach(({dr, dc, max}) => {
                for (let k = 1; k <= max; k++) {
                    const nr = r + (dr * k);
                    const nc = c + (dc * k);

                    if (nr >= 0 && nr < ROWS && nc >= 0 && nc < COLS) {
                        const target = board[nr][nc];
                        if (target === null) {
                            moves.push({ r: nr, c: nc });
                        } else {
                            if (target.player !== piece.player) {
                                if (piece.type.id !== 'LADY') {
                                    moves.push({ r: nr, c: nc, isCapture: true });
                                }
                            }
                            break; 
                        }
                    } else {
                        break; 
                    }
                }
            });

            return moves;
        };

        // --- ACCIONS ---

        function handleNameInput(e) {
            state.inputText = e.target.value;
            const btn = document.getElementById('startBtn');
            if(btn) btn.disabled = !state.inputText.trim();
        }

        function handleNameSubmit(e) {
            e.preventDefault();
            if (state.inputText.trim()) {
                state.playerName = state.inputText;
                startNewRound();
            }
        }

        function resetApp() {
            state.scores = { player: 0, cpu: 0 };
            state.playerName = "Jugador";
            state.phase = 'name';
            state.inputText = "";
            state.board = [];
            render();
        }

        function startNewRound() {
            playSound('START');
            const newBoard = Array(ROWS).fill(null).map(() => Array(COLS).fill(null));
            const cpuArmy = [...BASE_ARMY].sort(() => Math.random() - 0.5);
            const playerArmy = [...BASE_ARMY].sort(() => Math.random() - 0.5);

            const strategies = ['CAPTURE', 'CORONATION', 'SACRIFICE'];
            state.cpuStrategy = strategies[Math.floor(Math.random() * strategies.length)];

            let cpuIdx = 0;
            for (let r = 0; r <= 1; r++) {
                for (let c = 0; c < COLS; c++) {
                    newBoard[r][c] = { player: 1, type: cpuArmy[cpuIdx], revealed: false, id: `cpu_${cpuIdx}` };
                    cpuIdx++;
                }
            }
            let p1Idx = 0;
            for (let r = ROWS - 2; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    newBoard[r][c] = { player: 0, type: playerArmy[p1Idx], revealed: true, id: `p1_${p1Idx}` };
                    p1Idx++;
                }
            }

            state.board = newBoard;
            state.eliminated = { 0: [], 1: [] };
            state.phase = 'setup';
            state.winner = null;
            state.winReason = "";
            state.animatingMove = null;
            state.cpuLastMoveInfo = null;
            state.observedMoves = {};
            state.lastMove = null;
            state.history = [];
            
            render();
        }

        function startGame() {
            const startingTurn = Math.random() < 0.5 ? 0 : 1;
            state.turn = startingTurn;
            state.phase = 'playing';
            state.selectedPos = null;
            state.validMoves = [];
            state.history = [];
            render();
            
            if (state.turn === 1) {
                setTimeout(cpuTurn, 800);
            }
        }

        function saveHistory() {
            const newHist = [...state.history, {
                board: cloneBoard(state.board),
                turn: state.turn,
                eliminated: { 0: [...state.eliminated[0]], 1: [...state.eliminated[1]] },
                lastMove: state.lastMove,
                cpuLastMoveInfo: state.cpuLastMoveInfo,
                observedMoves: {...state.observedMoves}
            }];
            if (newHist.length > 50) newHist.shift();
            state.history = newHist;
        }

        function handleUndo() {
            if (state.history.length === 0 || state.phase !== 'playing' || state.turn === 1) return;
            const previousState = state.history[state.history.length - 1];
            
            state.board = previousState.board;
            state.turn = previousState.turn;
            state.eliminated = previousState.eliminated;
            state.lastMove = previousState.lastMove;
            state.cpuLastMoveInfo = previousState.cpuLastMoveInfo;
            state.observedMoves = previousState.observedMoves;
            state.winner = null;
            state.history.pop();
            render();
        }

        function handleSetupClick(r, c) {
            if (r < ROWS - 2) return;
            if (state.selectedPos) {
                const newBoard = cloneBoard(state.board);
                const pieceA = newBoard[state.selectedPos.r][state.selectedPos.c];
                const pieceB = newBoard[r][c];
                newBoard[state.selectedPos.r][state.selectedPos.c] = pieceB;
                newBoard[r][c] = pieceA;
                state.board = newBoard;
                state.selectedPos = null;
                playSound('MOVE');
                render();
            } else {
                state.selectedPos = { r, c };
                render();
            }
        }

        function handleCellClick(r, c) {
            if (state.animatingMove) return;
            if (state.phase !== 'playing') {
                if (state.phase === 'setup') handleSetupClick(r, c);
                return;
            }
            if (state.turn !== 0) return;

            const clickedPiece = state.board[r] ? state.board[r][c] : null;
            if (clickedPiece && clickedPiece.player === 0) {
                state.selectedPos = { r, c };
                state.validMoves = getValidMoves(state.board, r, c, clickedPiece);
                render();
                return;
            }
            if (state.selectedPos) {
                const move = state.validMoves.find(m => m.r === r && m.c === c);
                if (move) {
                    initiateMove(state.selectedPos.r, state.selectedPos.c, r, c);
                    state.selectedPos = null;
                    state.validMoves = [];
                } else {
                    state.selectedPos = null;
                    state.validMoves = [];
                    render();
                }
            }
        }

        function initiateMove(fromR, fromC, toR, toC) {
            const piece = state.board[fromR][fromC];

            if (state.turn === 0) {
                saveHistory();
            } else {
                state.cpuLastMoveInfo = { pieceId: piece.id, fromR: fromR, fromC: fromC };
            }

            state.animatingMove = { piece: piece, fromR, fromC, toR, toC };
            playSound('MOVE');
            render();

            setTimeout(() => {
                finalizeMove(fromR, fromC, toR, toC);
                state.animatingMove = null;
                render();
                
                if (state.turn === 1 && state.phase === 'playing' && !state.winner) {
                    setTimeout(cpuTurn, 800);
                }
            }, 500);
        }

        function finalizeMove(fromR, fromC, toR, toC) {
            const newBoard = cloneBoard(state.board);
            const attacker = newBoard[fromR][fromC];
            const target = newBoard[toR][toC];
            const currentPlayer = attacker.player;

            state.lastMove = { fromR, fromC, toR, toC, player: currentPlayer };

            if (attacker.player === 0) {
                const dr = Math.abs(toR - fromR);
                const dc = Math.abs(toC - fromC);
                let moveUpdates = [];
                if (dr > 1 || dc > 1) moveUpdates.push('soldier');
                if (dr > 0 && dc > 0) moveUpdates.push('diag');
                else if (dr > 0 || dc > 0) moveUpdates.push('ortho');
                if (target) moveUpdates.push('captured');

                if (moveUpdates.length > 0) {
                    const current = state.observedMoves[attacker.id] || [];
                    if (current.includes('soldier')) {
                        if (moveUpdates.includes('captured') && !current.includes('captured')) {
                            state.observedMoves[attacker.id] = [...current, 'captured'];
                        }
                    } else {
                        const currentSet = new Set(current);
                        moveUpdates.forEach(tag => currentSet.add(tag));
                        state.observedMoves[attacker.id] = Array.from(currentSet);
                    }
                }
            }

            let isGameOver = false;
            let finalWinner = null;
            let reason = "";
            const nextEliminated = { 0: [...state.eliminated[0]], 1: [...state.eliminated[1]] };

            newBoard[fromR][fromC] = null;

            if (target) {
                if (target.type.id === 'LADY') {
                    newBoard[toR][toC] = null;
                    nextEliminated[target.player].push(target);
                    nextEliminated[attacker.player].push(attacker);
                    if (attacker.type.id === 'CANDIDATE') {
                        isGameOver = true;
                        finalWinner = (currentPlayer === 0 ? 1 : 0);
                        reason = "Candidat eliminat per una Dama!";
                    }
                    playSound('CAPTURE');
                } else {
                    nextEliminated[target.player].push(target);
                    newBoard[toR][toC] = attacker;
                    if (target.type.id === 'CANDIDATE') {
                        isGameOver = true;
                        finalWinner = currentPlayer;
                        let killerName = attacker.type.name;
                        let article = "un";
                        if (attacker.type.id === 'CANDIDATE') { article = "l'altre"; killerName = "Candidat"; }
                        else if (attacker.type.id === 'SOLDIER') { article = "un"; killerName = "Soldat"; }
                        else if (attacker.type.id === 'NOBLE') { article = "un"; killerName = "Noble"; }
                        else if (attacker.type.id === 'COUNSELOR') { article = "un"; killerName = "Conseller"; }
                        reason = `Candidat capturat per ${article} ${killerName}!`;
                    }
                    playSound('CAPTURE');
                }
            } else {
                newBoard[toR][toC] = attacker;
            }

            state.eliminated = nextEliminated;

            if (!isGameOver) {
                const goalRow = currentPlayer === 0 ? 0 : ROWS - 1;
                const myCandidate = newBoard[goalRow].find(p => p && p.player === currentPlayer && p.type.id === 'CANDIDATE');
                if (myCandidate) {
                    isGameOver = true;
                    finalWinner = currentPlayer;
                    reason = "Candidat ha arribat al Palau!";
                }
                const cpuLadiesLost = nextEliminated[1].filter(p => p.type.id === 'LADY').length;
                if (cpuLadiesLost >= 2) {
                    isGameOver = true;
                    finalWinner = 1;
                    reason = "La CPU ha sacrificat les seves Dames i guanya!";
                }
                const playerLadiesLost = nextEliminated[0].filter(p => p.type.id === 'LADY').length;
                if (playerLadiesLost >= 2) {
                    isGameOver = true;
                    finalWinner = 0;
                    reason = "Has sacrificat les teves Dames i guanyes!";
                }
            }

            state.board = newBoard;

            if (isGameOver) {
                state.winner = finalWinner;
                state.winReason = reason;
                if (finalWinner === 0) state.scores.player += 1;
                else state.scores.cpu += 1;
                
                state.board = state.board.map(row => row.map(cell => cell ? { ...cell, revealed: true } : null));

                if (finalWinner === 0) playSound('WIN'); else playSound('LOSE');

                if (state.scores.player >= WINS_TO_MATCH || state.scores.cpu >= WINS_TO_MATCH) {
                    state.phase = 'matchover';
                } else {
                    state.phase = 'gameover';
                }
            } else {
                state.turn = currentPlayer === 0 ? 1 : 0;
            }
        }

        // --- LÒGICA IA ---
        function cpuTurn() {
            if (state.phase !== 'playing' || state.turn !== 1) return;

            let myPieces = [], enemyPieces = [];
            state.board.forEach((row, r) => {
                row.forEach((cell, c) => {
                    if (cell) {
                        if (cell.player === 1) myPieces.push({ r, c, piece: cell });
                        else enemyPieces.push({ r, c, piece: cell });
                    }
                });
            });

            const myKing = myPieces.find(p => p.piece.type.id === 'CANDIDATE');
            const cpuLadiesLost = state.eliminated[1].filter(p => p.type.id === 'LADY').length;
            const playerLadiesCaptured = state.eliminated[0].filter(p => p.type.id === 'LADY').length;

            let allMoves = [];
            myPieces.forEach(({ r, c, piece }) => {
                const moves = getValidMoves(state.board, r, c, piece);
                moves.forEach(m => {
                    allMoves.push({ from: {r, c}, to: m, piece });
                });
            });

            if (allMoves.length === 0) { 
                state.turn = 0; 
                render();
                return; 
            }

            let bestMove = null;
            let maxScore = -Infinity;

            allMoves.forEach(move => {
                let score = 0;
                const target = state.board[move.to.r][move.to.c];
                const isCandidate = move.piece.type.id === 'CANDIDATE';
                const isLady = move.piece.type.id === 'LADY';

                if (isCandidate && move.to.r === ROWS - 1) score += 999999;
                if (target && target.type.id === 'CANDIDATE') score += 999999;
                if (state.cpuLastMoveInfo && move.piece.id === state.cpuLastMoveInfo.pieceId) {
                    score -= 200; 
                    if (move.to.r === state.cpuLastMoveInfo.fromR && move.to.c === state.cpuLastMoveInfo.fromC) score -= 10000;
                }

                if (state.cpuStrategy === 'CORONATION' && isCandidate) score += 150; 
                if (state.cpuStrategy === 'CAPTURE' && target) score += 100; 
                if (state.cpuStrategy === 'SACRIFICE' && isLady) score += 50; 

                if (isLady) {
                    let isCurrentlyAdjacent = false;
                    enemyPieces.forEach(ep => {
                        if (Math.abs(ep.r - move.from.r) <= 1 && Math.abs(ep.c - move.from.c) <= 1) isCurrentlyAdjacent = true;
                    });
                    if (isCurrentlyAdjacent) score -= 500;
                    if (myKing && Math.abs(move.to.r - myKing.r) <= 1 && Math.abs(move.to.c - myKing.c) <= 1) score += 50;
                    score -= 20;
                } else if (isCandidate) {
                    let nearEnemy = false;
                    enemyPieces.forEach(ep => {
                        if (Math.abs(ep.r - move.to.r) <= 1 && Math.abs(ep.c - move.to.c) <= 1) nearEnemy = true;
                    });
                    if (nearEnemy) score -= 10000;
                    else {
                        if (move.to.r < move.from.r) score -= 1000;
                        score += move.to.r * (move.to.r > 3 ? 120 : 10);
                    }
                } else {
                    score += move.to.r * 25;
                    if (move.to.c >= 1 && move.to.c <= 3) score += 15;
                }

                if (target) score += 200;
                score += Math.random() * 15;
                if (score > maxScore) { maxScore = score; bestMove = move; }
            });

            if (bestMove) {
                initiateMove(bestMove.from.r, bestMove.from.c, bestMove.to.r, bestMove.to.c);
            }
        }

        // --- DRAG AND DROP HANDLERS ---
        let draggedData = null;

        function handleDragStart(e, r, c) {
            if (state.phase !== 'playing' || state.turn !== 0) return;
            const piece = state.board[r] ? state.board[r][c] : null;
            if (!piece || piece.player !== 0) return;

            draggedData = { r, c };
            handleCellClick(r, c); 
            e.dataTransfer.effectAllowed = "move";
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
        }

        function handleDrop(e, r, c) {
            e.preventDefault();
            if (state.phase !== 'playing' || state.turn !== 0 || !draggedData) return;

            const fromR = draggedData.r;
            const fromC = draggedData.c;
            const isValid = state.validMoves.some(m => m.r === r && m.c === c);

            if (isValid) {
                initiateMove(fromR, fromC, r, c);
                state.selectedPos = null;
                state.validMoves = [];
            }
            draggedData = null;
        }

        // --- FUNCIONS DE RENDERITZAT ---

        function renderMovementDots(type, colorClass, player) {
            let bgClass = colorClass.replace('text-', 'bg-');
            if (type.id === 'LADY') {
                const borderClass = colorClass.replace('text-', 'border-');
                bgClass = `bg-transparent border ${borderClass}`;
            }

            const baseStyle = `absolute w-1.5 h-1.5 rounded-full ${bgClass} shadow-sm`;
            let dotsHTML = '';
            const p = (pos) => `<div class="${baseStyle} ${pos}"></div>`;

            if (type.id === 'CANDIDATE' || type.id === 'LADY') {
                dotsHTML += p('top-1.5 left-1.5') + p('top-1.5 left-1/2 -translate-x-1/2') + p('top-1.5 right-1.5') +
                           p('top-1/2 right-1 -translate-y-1/2') + p('bottom-1.5 right-1.5') + p('bottom-1.5 left-1/2 -translate-x-1/2') +
                           p('bottom-1.5 left-1.5') + p('top-1/2 left-1 -translate-y-1/2');
            } else if (type.id === 'COUNSELOR') {
                dotsHTML += p('top-1.5 left-1.5') + p('top-1.5 right-1.5') + p('bottom-1.5 right-1.5') + p('bottom-1.5 left-1.5');
            } else if (type.id === 'NOBLE') {
                dotsHTML += p('top-1.5 left-1/2 -translate-x-1/2') + p('top-1/2 right-1 -translate-y-1/2') +
                           p('bottom-1.5 left-1/2 -translate-x-1/2') + p('top-1/2 left-1 -translate-y-1/2');
            } else if (type.id === 'SOLDIER') {
                if (player === 0) dotsHTML += p('top-1.5 left-1/2 -translate-x-1/2');
                else dotsHTML += p('bottom-1.5 left-1/2 -translate-x-1/2');
            }
            return dotsHTML;
        }

        function renderPiece(piece, isAnimating = false) {
            if (!piece) return '';
            const isVisible = piece.player === 0 || piece.revealed;
            const rotation = piece.type.id === 'SOLDIER' && piece.player === 1 ? 'rotate-180' : '';
            const colorClass = PIECE_COLORS[piece.type.id];
            
            let content = '';
            let boxClass = '';

            if (isVisible) {
                boxClass = piece.player === 0 
                    ? 'bg-amber-100 text-amber-900 border border-amber-400 shadow-[0_4px_0_#b45309]' 
                    : 'bg-rose-200 text-rose-900 border border-rose-400 shadow-[0_4px_0_#e11d48]';
                
                content = `
                    ${renderMovementDots(piece.type, colorClass, piece.player)}
                    <i data-lucide="${piece.type.icon}" width="32" height="32" class="${colorClass} relative z-10 ${rotation}" stroke-width="2"></i>
                `;
            } else {
                boxClass = 'bg-rose-300 border border-rose-400 shadow-[0_4px_0_#e11d48]';
                content = `<span class="text-3xl font-bold text-rose-500">?</span>`;
            }

            const cursorClass = (state.phase === 'playing' && piece.player === 0) ? 'cursor-grab active:cursor-grabbing' : '';
            const dragAttr = (state.phase === 'playing' && piece.player === 0) ? 'draggable="true"' : '';
            
            return `
                <div 
                    class="flex items-center justify-center w-[85%] h-[85%] rounded shadow-md transition-all duration-300 relative ${boxClass} ${cursorClass}"
                    ${dragAttr}
                    onmousedown="if(this.getAttribute('draggable') === 'true') handleDragStart(event, ${isAnimating ? 'null' : 'this.parentNode.dataset.r'}, ${isAnimating ? 'null' : 'this.parentNode.dataset.c'})"
                >
                    ${content}
                </div>
            `;
        }

        function renderBoard() {
            let html = `
            <div class="relative mx-auto select-none w-full max-w-[500px]">
                <div class="grid gap-0.5 bg-slate-900 p-1 rounded border-4 border-slate-800 shadow-2xl relative" 
                     style="grid-template-columns: repeat(${COLS}, minmax(0, 1fr));">
            `;

            if (state.animatingMove) {
                const { piece, fromR, fromC, toR, toC } = state.animatingMove;
                const top = (fromR * 100 / ROWS);
                const left = (fromC * 100 / COLS);
                const transX = (toC - fromC) * 100;
                const transY = (toR - fromR) * 100;
                
                html += `
                <div class="absolute z-20 pointer-events-none transition-all duration-500 ease-in-out"
                     style="width: calc(100% / ${COLS}); height: calc(100% / ${ROWS}); top: ${top}%; left: ${left}%; transform: translate(${transX}%, ${transY}%)">
                     <div class="w-full h-full flex items-center justify-center p-1">
                        ${renderPiece(piece, true)}
                     </div>
                </div>
                `;
            }

            for (let r = 0; r < ROWS; r++) {
                for (let c = 0; c < COLS; c++) {
                    const isDark = (r + c) % 2 === 1;
                    let bgClass = "bg-slate-700";
                    if (isDark) bgClass = "bg-slate-800";
                    if (r === 0) bgClass = isDark ? "bg-orange-800" : "bg-orange-600";
                    if (r === ROWS - 1) bgClass = isDark ? "bg-emerald-800" : "bg-emerald-600";
                    
                    let ringClass = "";
                    let zIndex = "z-0";

                    // FIX: Comprovació de seguretat per evitar TypeError quan state.board està buit
                    const pieceAtCell = (state.board[r] && state.board[r][c]) ? state.board[r][c] : null;

                    if (state.lastMove && state.lastMove.toR === r && state.lastMove.toC === c && !pieceAtCell) {
                         const ringColor = state.lastMove.player === 0 ? 'ring-emerald-500' : 'ring-orange-500';
                         ringClass += ` ring-4 ${ringColor}`;
                    }
                    
                    if (state.phase === 'playing' && state.selectedPos) {
                        const isSelected = state.selectedPos.r === r && state.selectedPos.c === c;
                        const isValid = state.validMoves.some(m => m.r === r && m.c === c);
                        const isCapture = state.validMoves.some(m => m.r === r && m.c === c && m.isCapture);

                        if (isSelected) {
                            ringClass = " ring-4 ring-blue-500";
                            zIndex = "z-10";
                        } else if (isCapture) {
                            bgClass = "bg-red-900/50";
                            ringClass = " ring-4 ring-red-500 cursor-pointer";
                        } else if (isValid) {
                            bgClass = "bg-green-900/50";
                            ringClass = " ring-4 ring-green-500 cursor-pointer";
                        }
                    } else if (state.phase === 'setup' && r >= ROWS - 2) {
                        ringClass = " cursor-pointer hover:bg-slate-600 border-dashed border-slate-500";
                        if (state.selectedPos && state.selectedPos.r === r && state.selectedPos.c === c) {
                            ringClass += " ring-2 ring-yellow-400";
                        }
                    }

                    const palaceClass = (r === 0 || r === ROWS - 1) ? 'palace-pattern' : '';
                    
                    const isAnimatingSrc = state.animatingMove && state.animatingMove.fromR === r && state.animatingMove.fromC === c;
                    const cellContent = (!isAnimatingSrc && pieceAtCell) ? renderPiece(pieceAtCell) : '';

                    let lastMoveMarker = '';
                    if (state.lastMove && state.lastMove.fromR === r && state.lastMove.fromC === c) {
                        const borderColor = state.lastMove.player === 0 ? 'border-emerald-500' : 'border-orange-500';
                        lastMoveMarker = `<div class="absolute w-2 h-2 rounded-full border-2 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 ${borderColor}"></div>`;
                    }

                    let targetHighlight = '';
                    if (pieceAtCell && state.lastMove && state.lastMove.toR === r && state.lastMove.toC === c) {
                        const ringColor = state.lastMove.player === 0 ? 'ring-emerald-500' : 'ring-orange-500';
                        targetHighlight = ` ring-4 ${ringColor} ring-offset-2 ring-offset-slate-900`;
                    }
                    
                    html += `
                        <div class="w-full aspect-square border border-slate-700 flex items-center justify-center relative ${bgClass} ${ringClass} ${targetHighlight} ${zIndex} ${palaceClass}"
                             data-r="${r}" data-c="${c}"
                             onclick="handleCellClick(${r}, ${c})"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event, ${r}, ${c})">
                             ${lastMoveMarker}
                             ${cellContent}
                        </div>
                    `;
                }
            }

            html += `</div></div>`;
            return html;
        }

        function renderGraveyard(pieces, label) {
            let html = `
            <div class="bg-slate-900 p-2 rounded border border-slate-800 flex flex-col gap-2 min-h-[80px]">
                <h4 class="text-xs font-bold text-slate-400 uppercase">${label}</h4>
                <div class="flex flex-wrap gap-1">
                    ${pieces.length === 0 ? '<span class="text-xs text-slate-600 italic">Cap baixa</span>' : ''}
                    ${pieces.map(p => {
                        const colorClass = p.player === 0 ? 'bg-amber-100 border-amber-400 text-amber-900' : 'bg-rose-200 border-rose-400 text-rose-900';
                        const rotation = p.type.id === 'SOLDIER' && p.player === 1 ? 'rotate-180' : '';
                        return `
                        <div class="w-8 h-8 rounded flex items-center justify-center border shadow-sm ${colorClass}" title="${p.type.name}">
                            <i data-lucide="${p.type.icon}" width="18" height="18" class="${PIECE_COLORS[p.type.id]} ${rotation}"></i>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
            return html;
        }

        function renderScoreboard() {
            return `
            <div class="bg-slate-900 p-2 rounded border border-slate-800 flex flex-col gap-2 min-h-[80px]">
                <h4 class="text-xs font-bold text-amber-400 uppercase flex items-center gap-2 border-b border-slate-800 pb-1">
                    <i data-lucide="trophy" width="14" height="14"></i> Marcador (${WINS_TO_MATCH} victòries)
                </h4>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300 font-bold">${state.playerName}</span>
                        <div class="flex gap-1 bg-slate-800 px-2 py-1 rounded h-6 items-center min-w-[60px] justify-end">
                            ${Array(state.scores.player).fill(0).map(() => `<i data-lucide="crown" width="12" height="12" class="text-amber-500 fill-amber-500"></i>`).join('')}
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-slate-300 font-bold">CPU</span>
                        <div class="flex gap-1 bg-slate-800 px-2 py-1 rounded h-6 items-center min-w-[60px] justify-end">
                            ${Array(state.scores.cpu).fill(0).map(() => `<i data-lucide="crown" width="12" height="12" class="text-red-500 fill-red-500"></i>`).join('')}
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function renderModals() {
            if (state.phase === 'name') {
                return `
                <div class="fixed inset-0 z-[200] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                  <div class="bg-slate-800 border-2 border-orange-500 rounded-lg max-w-md w-full p-8 shadow-2xl text-center">
                    <h2 class="text-3xl font-bold text-orange-500 mb-6 flex justify-center items-center gap-2">
                      <i data-lucide="crown"></i> VOLTO DIGITAL
                    </h2>
                    <p class="text-slate-300 mb-6">Benvingut a l'arena. Introdueix el teu nom per començar el partit.</p>
                    <form onsubmit="handleNameSubmit(event)" class="flex flex-col gap-4">
                      <input 
                        type="text" 
                        value="${state.inputText}"
                        oninput="handleNameInput(event)"
                        placeholder="Nom del Jugador" 
                        class="w-full p-3 rounded bg-slate-900 border border-slate-700 text-white focus:border-orange-500 outline-none text-center text-lg"
                        autofocus
                      />
                      <button 
                        type="submit" 
                        id="startBtn"
                        ${!state.inputText.trim() ? 'disabled' : ''}
                        class="w-full py-3 bg-orange-600 hover:bg-orange-500 disabled:bg-slate-700 disabled:text-slate-500 text-white font-bold rounded transition-colors"
                      >
                        COMENÇAR MATCH
                      </button>
                    </form>
                    <p class="mt-4 text-xs text-slate-500">El primer a arribar a ${WINS_TO_MATCH} victòries guanya.</p>
                  </div>
                </div>`;
            }

            if (state.showRules) {
                return `
                <div class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div class="bg-slate-900 border-2 border-slate-700 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto relative shadow-2xl">
                      <button onclick="state.showRules = false; render()" class="absolute top-4 right-4 text-slate-400 hover:text-white">
                        <i data-lucide="x" width="24"></i>
                      </button>
                      
                      <div class="p-6 space-y-6 text-slate-200">
                        <h2 class="text-2xl font-bold text-orange-500 flex items-center gap-2">
                          <i data-lucide="help-circle"></i> Instruccions de Volto
                        </h2>
                        <section>
                          <h3 class="font-bold text-lg mb-2 text-slate-100 border-b border-slate-700 pb-1">Objectiu</h3>
                          <p class="text-sm text-slate-400">Una batalla d'estratègia oculta. No coneixes la identitat de les peces rivals fins que es mouen o actuen.</p>
                        </section>
                        <section>
                          <h3 class="font-bold text-lg mb-2 text-slate-100 border-b border-slate-700 pb-1">Moviments</h3>
                          <div class="grid grid-cols-1 gap-3 text-sm">
                             ${Object.values(TYPES).map(t => `
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-slate-800 rounded border border-slate-700"><i data-lucide="${t.icon}" width="20" class="${PIECE_COLORS[t.id]}"></i></div>
                                    <div>
                                        <span class="font-bold block ${PIECE_COLORS[t.id]}">${t.name}</span>
                                        ${t.id === 'LADY' ? '1 pas. <span class="text-red-300 font-bold">NO captura.</span>' : t.id === 'SOLDIER' ? 'Només endavant. Avança fins xocar.' : t.id === 'COUNSELOR' ? '1 pas en diagonal.' : t.id === 'NOBLE' ? '1 pas en creu.' : '1 pas en qualsevol direcció.'}
                                    </div>
                                </div>
                             `).join('')}
                          </div>
                        </section>
                        <button onclick="state.showRules = false; render()" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded font-bold transition-colors">Entesos!</button>
                      </div>
                    </div>
                </div>`;
            }
            return '';
        }

        function render() {
            const app = document.getElementById('app');
            const p0LadiesLost = state.eliminated[0].filter(p => p.type.id === 'LADY').length;
            const p1LadiesLost = state.eliminated[1].filter(p => p.type.id === 'LADY').length;

            const modalHTML = renderModals();

            const headerHTML = `
            <div class="w-full max-w-4xl flex flex-col gap-2 mb-4">
                <div class="flex justify-between items-center">
                    <h1 class="text-2xl font-bold flex items-center gap-2 text-orange-500">
                        <i data-lucide="crown" width="24" height="24"></i> VOLTO DIGITAL
                    </h1>
                    <div class="flex items-center gap-2">
                      <button onclick="state.soundEnabled = !state.soundEnabled; render()" class="p-2 bg-slate-800 rounded hover:bg-slate-700 text-slate-400" title="So">
                        <i data-lucide="${state.soundEnabled ? 'volume-2' : 'volume-x'}" width="20"></i>
                      </button>
                      <button onclick="handleUndo()" ${state.phase !== 'playing' || state.turn === 1 || state.history.length === 0 ? 'disabled' : ''} class="p-2 bg-slate-800 rounded hover:bg-slate-700 text-slate-400 disabled:opacity-30 disabled:cursor-not-allowed" title="Desfer">
                        <i data-lucide="rotate-ccw" width="20"></i>
                      </button>
                      <button onclick="state.showRules = true; render()" class="p-2 bg-slate-800 rounded hover:bg-slate-700 text-amber-400" title="Instruccions">
                        <i data-lucide="help-circle" width="20"></i>
                      </button>
                      <div class="text-sm px-3 py-1 bg-slate-800 rounded text-slate-300">
                          ${state.phase === 'setup' ? 'Fase de Preparació' : (state.turn === 0 ? `Torn: ${state.playerName}` : 'Torn: CPU')}
                      </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-900 border border-slate-800 p-2 rounded flex items-center justify-between">
                        <span class="text-xs text-slate-400 uppercase">Les teves Dames</span>
                        <div class="flex gap-1">
                           ${[0, 1].map(i => `<i data-lucide="heart" width="16" class="${i < p0LadiesLost ? "text-red-500 fill-red-500" : "text-slate-700"}"></i>`).join('')}
                        </div>
                    </div>
                    <div class="bg-slate-900 border border-slate-800 p-2 rounded flex items-center justify-between">
                        <span class="text-xs text-slate-400 uppercase">Dames CPU</span>
                        <div class="flex gap-1">
                           ${[0, 1].map(i => `<i data-lucide="heart" width="16" class="${i < p1LadiesLost ? "text-red-500 fill-red-500" : "text-slate-700"}"></i>`).join('')}
                        </div>
                    </div>
                </div>
            </div>`;

            const sidebarHTML = `
            <div class="w-full lg:w-72 flex flex-col gap-3">
                ${renderGraveyard(state.eliminated[0], "Les teves baixes (Jugador)")}
                ${renderGraveyard(state.eliminated[1], "Baixes Enemic (CPU)")}
                ${renderScoreboard()}

                ${state.phase === 'setup' ? `
                    <div class="bg-slate-800 p-4 rounded border border-slate-700 shadow-lg mt-2">
                        <h3 class="font-bold text-amber-400 mb-2 text-sm flex items-center gap-2"><i data-lucide="user" width="16"></i> PREPARACIÓ</h3>
                        <p class="text-xs text-slate-400 mb-4">Les teves peces s'han col·locat aleatòriament. Pots moure-les o començar.<br/>Si perds les 2 Dames, GUANYES.</p>
                        <button onclick="startNewRound()" class="w-full mb-2 py-1 border border-slate-600 rounded text-slate-300 text-xs hover:bg-slate-700">Rebarrejar</button>
                        <button onclick="startGame()" class="w-full py-2 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded text-sm">LLUITA!</button>
                    </div>
                ` : ''}

                <div class="grid grid-cols-1 gap-2 text-xs text-slate-400 bg-slate-900 p-3 rounded mt-auto">
                    <div class="font-bold text-slate-200 mb-1 border-b border-slate-800 pb-1">Moviments</div>
                    ${Object.values(TYPES).map(t => `
                        <div class="flex items-center justify-between">
                            <span class="flex items-center gap-1"><i data-lucide="${t.icon}" width="12" class="${PIECE_COLORS[t.id]}"></i> ${t.name}</span>
                            <span class="text-[10px] text-slate-500 truncate max-w-[100px]">${t.id==='LADY' ? '1 pas (No mata)' : t.id==='SOLDIER' ? 'Endavant fins topar' : '1 pas'}</span>
                        </div>
                    `).join('')}
                </div>

                ${(state.phase === 'gameover' || state.phase === 'matchover') ? `
                    <div class="bg-slate-900 border-2 border-slate-700 p-4 rounded-lg text-center animate-fade-in mt-auto">
                        ${state.phase === 'matchover' ? `
                            <h2 class="text-xl font-bold mb-2 ${state.winner === 0 ? 'text-green-400' : 'text-red-500'}">
                                ${state.winner === 0 ? `${state.playerName} GUANYA EL PARTIT!` : 'LA CPU GUANYA EL PARTIT!'}
                            </h2>
                            <button onclick="resetApp()" class="w-full px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white font-bold rounded flex justify-center items-center gap-2">
                                <i data-lucide="log-out" width="18"></i> Reiniciar Tot
                            </button>
                        ` : `
                            <h2 class="text-xl font-bold mb-2 ${state.winner === 0 ? 'text-green-400' : 'text-red-500'}">
                                ${state.winner === 0 ? 'VICTÒRIA DE RONDA!' : 'DERROTA DE RONDA'}
                            </h2>
                            <p class="mb-4 text-xs text-slate-300">${state.winReason}</p>
                            <div class="flex flex-col gap-2">
                                <button onclick="startNewRound()" class="w-full px-4 py-2 bg-orange-600 hover:bg-orange-500 text-white font-bold rounded flex justify-center items-center gap-2">
                                    <i data-lucide="refresh-ccw" width="18"></i> Nova Ronda
                                </button>
                                <button onclick="resetApp()" class="w-full px-4 py-2 border border-slate-600 hover:bg-slate-700 text-slate-300 font-bold rounded flex justify-center items-center gap-2">
                                    <i data-lucide="log-out" width="18"></i> Reiniciar Match
                                </button>
                            </div>
                        `}
                    </div>
                ` : ''}
            </div>`;

            app.innerHTML = `
                ${modalHTML}
                ${headerHTML}
                <div class="flex flex-col lg:flex-row gap-6 w-full max-w-5xl justify-center items-start">
                    ${renderBoard()}
                    ${sidebarHTML}
                </div>
            `;

            lucide.createIcons();
            
            if(state.phase === 'name') {
                 const input = document.querySelector('input');
                 if(input && state.inputText) {
                     input.focus();
                     const val = input.value;
                     input.value = '';
                     input.value = val;
                 }
            }
        }

        render();

    </script>
</body>
</html>
